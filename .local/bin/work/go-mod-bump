#!/usr/bin/bash

DEP=${1:-}
VERSION=${2:-}

DO_COMMIT=0

if [[ "$DEP" == "" ]]; then
    echo "DEP must be provided!"
    exit 1
fi

if [[ "$VERSION" == "" ]]; then
    echo "VERSION must be provided!"
    exit 1
fi

function find_dep_fuzzy() {
    echo $(grep -Po "\w.*$1*\/\w*\d*(?!.*\/\/ indirect)" go.mod)
}

function find_dep() {
    echo $(grep -Po "$1(?!.*\/\/ indirect)" go.mod)
}


DEP_FULLNAME=$(find_dep "$DEP")
if [[ $(echo $DEP | grep -o "/") == "" ]]; then
    DEP_FULLNAME=$(find_dep_fuzzy "$DEP")
fi

if [[ "$DEP_FULLNAME" == "" ]]; then
    echo "Unknown dependency $DEP"
    exit 1
fi

TIMESTAMP=$(date '+%F%T' | tr -d ':-')
BRANCH_NAME="chore/go-mod-bump-$TIMESTAMP"

go mod edit -require="$DEP_FULLNAME@$VERSION"
go mod tidy

if [[ "$(git status --porcelain)" != "" && $DO_COMMIT -eq 1 ]]; then
    git checkout -b "$BRANCH_NAME"
    git commit -am "Bumped $DEP_FULLNAME to $VERSION"
    git push -o merge_request.create -u origin "$BRANCH_NAME"
fi
