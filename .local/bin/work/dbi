#!/usr/bin/bash

if ! type "arthur" > /dev/null; then
    echo "Command 'arthur' not found"
    exit 1
fi

if ! type "psql" > /dev/null; then
    echo "Command 'psql' not found"
    exit 1
fi

function help() {
    cat <<EOF
dbi SERVICE ENVIRONMENT [COMMAND]

Example:
  dbi george staging

Command:
  --arthur (default)
      Connect to database via arthur PSQL. Uses your AWS credentials to login.
      Read-only mode is active by default, if you need write access there is two options
        1. Use param '--readwrite' when connecting
        2. Set your role after connecting with 'set role readwrite'
  --url
      Print postgres connection url.
      URL is valid for 15 min, but once connected your session is valid until you disconnect.
      Example output 'postgres://user:pass@host:port/db'
  --readwrite | --rw
      Connect to the database with read and write access.
  --root
      Connect to database as root user. Don't use this as default.
EOF
}

if [[ "$1" == "local" ]]; then
    echo "Connecting to localhost server"
    psql postgres://postgres:postgres@localhost:5432
    exit
fi

SERVICE=$1
ENVIRONMENT=$2
COMMAND=${3:-}

[[ "$SERVICE" == "" ]] && help && exit 1
[[ "$ENVIRONMENT" == "" ]] && help && exit 1

case $ENVIRONMENT in
    "stan")
        ENVIRONMENT="staging"
        ;&
    "staging")
        ;;
    "sand")
        ENVIRONMENT="sandbox"
        ;&
    "sandbox")
        ;;
    "prod")
        ENVIRONMENT="production"
        ;&
    "production")
        ;;
    *)
        echo "Invalid [ENVIRONMENT], most be either 'staging', 'sandbox' or 'production'"
        exit 1
esac

CONNECTED_TO_VPN=$(nmcli -t connection show --active | grep zimpler)
if [[ "$CONNECTED_TO_VPN" == "" ]]; then
    echo "You need to be connected to Zimpler vpn!"
    exit 1
fi

case $COMMAND in
    "")
        ;&
    "--arthur")
        if ! arthur psql "$SERVICE-$ENVIRONMENT"; then
            echo "Failed to login with normal database name, trying with legacy name"
            if ! arthur psql "$SERVICE-$ENVIRONMENT-db"; then
                echo "Invalid or unsupported [SERVICE]"
                exit 1
            fi
        fi
        exit
        ;;
    "--url")
        URL=$(arthur db-connection-url "$SERVICE-$ENVIRONMENT")
        echo "$URL"
        exit
        ;;
    "--rw")
        ;&
    "--readwrite")
        arthur psql "$SERVICE-$ENVIRONMENT" --readwrite || echo "Invalid or unspported [SERVICE]" && exit 1
        ;;
    "--root")
        arthur psql "$SERVICE-$ENVIRONMENT" --root || echo "Invalid or unspported [SERVICE]" && exit 1
        exit
        ;;
    *)
        help
        exit 1
esac
